---
title: è¯­è¨€æ¨¡å‹æ¶æ„
author: wangzf
date: '2024-10-26'
slug: lm-arch
categories:
  - nlp
  - deeplearning
tags:
  - model
---

<style>
details {
    border: 1px solid #aaa;
    border-radius: 4px;
    padding: .5em .5em 0;
}
summary {
    font-weight: bold;
    margin: -.5em -.5em 0;
    padding: .5em;
}
details[open] {
    padding: .5em;
}
details[open] summary {
    border-bottom: 1px solid #aaa;
    margin-bottom: .5em;
}
img {
    pointer-events: none;
}
</style>

<details><summary>ç›®å½•</summary><p>

- [æ¨¡å‹æ¦‚è¿°](#æ¨¡å‹æ¦‚è¿°)
- [åˆ†è¯](#åˆ†è¯)
    - [åŸºäºç©ºæ ¼çš„åˆ†è¯](#åŸºäºç©ºæ ¼çš„åˆ†è¯)
    - [Byte Pair Encoding](#byte-pair-encoding)
    - [Unigram model](#unigram-model)
- [æ¨¡å‹æ¶æ„](#æ¨¡å‹æ¶æ„)
    - [Encoder-Only æ¶æ„](#encoder-only-æ¶æ„)
    - [Decoder-Only æ¶æ„](#decoder-only-æ¶æ„)
    - [Encoder-Decoder æ¶æ„](#encoder-decoder-æ¶æ„)
- [è¯­è¨€æ¨¡å‹ç†è®º](#è¯­è¨€æ¨¡å‹ç†è®º)
    - [åŸºç¡€æ¶æ„](#åŸºç¡€æ¶æ„)
    - [RNN](#rnn)
    - [Transformer](#transformer)
        - [Attention](#attention)
        - [æ®‹å·®è¿æ¥å’Œå½’ä¸€åŒ–](#æ®‹å·®è¿æ¥å’Œå½’ä¸€åŒ–)
        - [ä½ç½®åµŒå…¥](#ä½ç½®åµŒå…¥)
    - [GPT-3](#gpt-3)
- [æ–°çš„æ¨¡å‹æ¶æ„](#æ–°çš„æ¨¡å‹æ¶æ„)
    - [æ··åˆä¸“å®¶æ¨¡å‹](#æ··åˆä¸“å®¶æ¨¡å‹)
    - [åŸºäºæ£€ç´¢çš„æ¨¡å‹](#åŸºäºæ£€ç´¢çš„æ¨¡å‹)
</p></details><p></p>


# æ¨¡å‹æ¦‚è¿°

ä»å½¢è±¡åŒ–çš„æ¦‚å¿µç†è§£ä¸Šæ¥è¯´å½“å‰å¤§è¯­è¨€æ¨¡å‹(â€œå¤§â€ ä½“ç°åœ¨æ¨¡å‹çš„è§„æ¨¡ä¸Š)çš„èƒ½åŠ›ï¼Œ
å…¶å¯ä»¥æ ¹æ®è¾“å…¥éœ€æ±‚çš„è¯­è¨€æè¿°(Prompt)ç”Ÿæˆç¬¦åˆéœ€æ±‚çš„ç»“æœ(Completion)ï¼Œå½¢å¼å¯ä»¥è¡¨è¾¾ä¸ºï¼š

`$$\text{Prompt} \stackrel{\text{model}}{\leadsto} \text{Completion or Model(Prompt)} = \text{Completion}$$`

ä¸‹é¢ä»å¤§è¯­è¨€æ¨¡å‹çš„è®­ç»ƒæ•°æ®(training data)åˆ†æå¼€å§‹ï¼Œé¦–å…ˆç»™å‡ºå¦‚ä¸‹çš„å½¢å¼æè¿°ï¼š

`$$\text{training data} \Rightarrow p(x_{1}, \cdots, x_{L})$$`

æ¥ç€ï¼Œè®¨è®ºå¤§è¯­è¨€æ¨¡å‹æ˜¯å¦‚ä½•æ„å»ºçš„ï¼ŒåŒ…å«ä¸¤ä¸ªä¸»é¢˜ï¼š

* åˆ†è¯(Tokenization)ï¼šå¦‚ä½•å°†ä¸€ä¸ªå­—ç¬¦ä¸²æ‹†åˆ†æˆå¤šä¸ªè¯å…ƒ(token)
* æ¨¡å‹æ¶æ„(Model Architecture)ï¼šTransformer æ¶æ„ï¼Œè¿™æ˜¯çœŸæ­£å®ç°å¤§è¯­è¨€æ¨¡å‹çš„å»ºæ¨¡åˆ›æ–°

# åˆ†è¯

**è¯­è¨€æ¨¡å‹ `$p$`** æ˜¯å»ºç«‹åœ¨ **è¯å…ƒ(token)åºåˆ—** çš„ä¸Šä¸€ä¸ªæ¦‚ç‡åˆ†å¸ƒè¾“å‡ºçš„ï¼Œ
å…¶ä¸­æ¯ä¸ª **è¯å…ƒ(token)** æ¥è‡ªæŸä¸ª **è¯æ±‡è¡¨** `$V$`ã€‚æ¯”å¦‚ä»¥ä¸‹çš„å½¢å¼ï¼š

```
[the, mouse, ate, the, cheese]
```

**è¯å…ƒ(token)** ä¸€èˆ¬åœ¨ NLPï¼ˆè‡ªç„¶è¯­è¨€å¤„ç†ï¼‰ä¸­æ¥è¯´ï¼Œé€šå¸¸æŒ‡çš„æ˜¯ä¸€ä¸ªæ–‡æœ¬åºåˆ—ä¸­çš„æœ€å°å•å…ƒï¼Œ
å¯ä»¥æ˜¯ **å•è¯**ã€**æ ‡ç‚¹ç¬¦å·**ã€**æ•°å­—**ã€**ç¬¦å·** æˆ– **å…¶ä»–ç±»å‹çš„è¯­è¨€å…ƒç´ **ã€‚
é€šå¸¸ï¼Œå¯¹äº NLP ä»»åŠ¡ï¼Œæ–‡æœ¬åºåˆ—ä¼šè¢«åˆ†è§£ä¸ºä¸€ç³»åˆ—çš„ tokensï¼Œä»¥ä¾¿è¿›è¡Œåˆ†æã€ç†è§£æˆ–å¤„ç†ã€‚
åœ¨è‹±æ–‡ä¸­ä¸€ä¸ª "token" å¯ä»¥æ˜¯ä¸€ä¸ª **å•è¯**ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ª **æ ‡ç‚¹ç¬¦å·**ã€‚
åœ¨ä¸­æ–‡ä¸­ï¼Œé€šå¸¸ä»¥ **å­—** æˆ– **è¯** ä½œä¸º tokenï¼ˆè¿™å…¶ä¸­å°±åŒ…å«ä¸€äº›å­—ç¬¦ä¸²åˆ†è¯çš„å·®å¼‚æ€§ï¼‰ã€‚

**å­—ç¬¦ä¸²** å’Œ **è¯å…ƒåºåˆ—** çš„å·®å¼‚æ€§ï¼š

* å­—ç¬¦ä¸²ï¼šå­—æ¯ã€ç¬¦å·å’Œç©ºæ ¼éƒ½æ˜¯è¿™è¿™ä¸ªå­—ç¬¦ä¸²çš„ä¸€éƒ¨åˆ†ã€‚
* è¯å…ƒåºåˆ—ï¼šç”±å¤šä¸ªå­—ç¬¦ä¸²ç»„æˆã€‚ç›¸å½“äºæŠŠä¸€ä¸ªå­—ç¬¦ä¸²åˆ†å‰²ä¸ºäº†å¤šä¸ª **å­å­—ç¬¦ä¸²**ï¼Œæ¯ä¸ªå­å­—ç¬¦ä¸²æ˜¯ä¸€ä¸ªè¯å…ƒã€‚

è‡ªç„¶è¯­è¨€å¹¶ä¸æ˜¯ä»¥è¯å…ƒåºåˆ—çš„å½¢å¼å‡ºç°ï¼Œè€Œæ˜¯ä»¥å­—ç¬¦ä¸²çš„å½¢å¼å­˜åœ¨ï¼ˆå…·ä½“æ¥è¯´ï¼Œæ˜¯ Unicode å­—ç¬¦çš„åºåˆ—ï¼‰ï¼Œ
æ¯”å¦‚ä¸Šé¢çš„åºåˆ—çš„è‡ªç„¶è¯­è¨€ä¸º 

```
"the mouse ate the cheese."
```

**åˆ†è¯å™¨å°†ä»»æ„å­—ç¬¦ä¸²è½¬æ¢ä¸ºè¯å…ƒåºåˆ—ã€‚** æ¯”å¦‚ï¼š

```
"the mouse ate the cheese." => ["the", "mouse", "ate", "the", "cheese", "."]
```

è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè™½ç„¶è¿™éƒ¨åˆ†å¹¶ä¸ä¸€å®šæ˜¯è¯­è¨€å»ºæ¨¡ä¸­æœ€å¼•äººæ³¨ç›®çš„éƒ¨åˆ†ï¼Œ
ä½†åœ¨ç¡®å®šæ¨¡å‹çš„å·¥ä½œæ•ˆæœæ–¹é¢èµ·ç€éå¸¸é‡è¦çš„ä½œç”¨ã€‚
ä¹Ÿå¯ä»¥å°†è¿™ä¸ªæ–¹å¼ç†è§£ä¸º **è‡ªç„¶è¯­è¨€** å’Œ **æœºå™¨è¯­è¨€** çš„ä¸€ç§**éšå¼çš„å¯¹é½**ï¼Œ
ä¹Ÿå¯èƒ½æ˜¯å¯¹äºè¯­è¨€æ¨¡å‹å¯èƒ½å¼€å§‹æ¥è§¦çš„æ—¶å€™æœ€å›°æƒ‘çš„åœ°æ–¹ï¼Œç‰¹åˆ«æ˜¯åšæœºå™¨å­¦ä¹ ç›¸å…³çš„äººå‘˜ï¼Œ
å› ä¸ºæ—¥å¸¸äº†è§£çš„è¾“å…¥éœ€è¦æ˜¯æ•°å€¼çš„ï¼Œä»è€Œæ‰èƒ½åœ¨æ¨¡å‹ä¸­è¢«è®¡ç®—ï¼Œæ‰€ä»¥ï¼Œ
å¦‚æœè¾“å…¥æ˜¯éæ•°å€¼ç±»å‹çš„å­—ç¬¦ä¸²æ˜¯æ€ä¹ˆå¤„ç†çš„å‘¢ï¼Ÿ

> ä¸ºä»€ä¹ˆè¯´æ˜¯â€œéšå¼çš„å¯¹é½â€ï¼Œè¿™æ˜¯ç”±äºæ¯ä¸€ä¸ªè¯åœ¨æ¨¡å‹ä¸­ï¼Œéƒ½æœ‰ä¸€ä¸ªå…¶ç¡®å®šçš„è¯å‘é‡ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å°±ä¸€æ­¥ä¸€æ­¥æ¥çœ‹ï¼Œç ”ç©¶è€…ä»¬æ˜¯æ€ä¹ˆè®²ä¸€ä¸ªå­—ç¬¦ä¸²æ–‡æœ¬å˜æˆæœºå™¨èƒ½è®¡ç®—çš„æ•°å€¼çš„ã€‚

## åŸºäºç©ºæ ¼çš„åˆ†è¯

**åˆ†è¯**ï¼Œå…¶å®ä»å­—é¢å¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯æŠŠè¯åˆ†å¼€ï¼Œä»è€Œæ–¹ä¾¿å¯¹äºè¯è¿›è¡Œå•ç‹¬çš„ç¼–ç ã€‚
å¯¹äºè‹±æ–‡å­—æ¯æ¥è¯´ï¼Œç”±äºå…¶å¤©ç„¶çš„ä¸»è¦ç”± `å•è¯+ç©ºæ ¼+æ ‡ç‚¹ç¬¦å·` ç»„æˆï¼Œ
æœ€ç®€å•çš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨ `text.split(' ')` æ–¹å¼è¿›è¡Œåˆ†è¯ï¼Œè¿™ç§åˆ†è¯æ–¹å¼å¯¹äºè‹±æ–‡è¿™ç§æŒ‰ç…§ç©ºæ ¼ï¼Œ
ä¸”æ¯ä¸ªåˆ†è¯åçš„å•è¯æœ‰è¯­ä¹‰å…³ç³»çš„æ–‡æœ¬æ˜¯ç®€å•è€Œç›´æ¥çš„åˆ†è¯æ–¹å¼ã€‚

ç„¶è€Œï¼Œå¯¹äºä¸€äº›è¯­è¨€ï¼Œå¦‚ä¸­æ–‡ï¼Œå¥å­ä¸­çš„å•è¯ä¹‹é—´æ²¡æœ‰ç©ºæ ¼ï¼Œä¾‹å¦‚ä¸‹æ–‡çš„å½¢å¼ï¼š

```
"æˆ‘ä»Šå¤©å»äº†å•†åº—ã€‚"
```

è¿˜æœ‰ä¸€äº›è¯­è¨€ï¼Œæ¯”å¦‚å¾·è¯­ï¼Œå­˜åœ¨ç€é•¿çš„å¤åˆè¯ï¼ˆä¾‹å¦‚ `Abwasserbehandlungsanlange`ï¼‰ã€‚
å³ä½¿åœ¨è‹±è¯­ä¸­ï¼Œä¹Ÿæœ‰è¿å­—ç¬¦è¯ï¼ˆä¾‹å¦‚ `father-in-law`ï¼‰å’Œç¼©ç•¥è¯ï¼ˆä¾‹å¦‚ `don't`ï¼‰ï¼Œå®ƒä»¬éœ€è¦è¢«æ­£ç¡®æ‹†åˆ†ã€‚
ä¾‹å¦‚ï¼ŒPenn Treebank å°† `don't` æ‹†åˆ†ä¸º `do` å’Œ `n't`ï¼Œè¿™æ˜¯ä¸€ä¸ªåœ¨è¯­è¨€ä¸ŠåŸºäºä¿¡æ¯çš„é€‰æ‹©ï¼Œä½†ä¸å¤ªæ˜æ˜¾ã€‚
å› æ­¤ï¼Œä»…ä»…é€šè¿‡ç©ºæ ¼æ¥åˆ’åˆ†å•è¯ä¼šå¸¦æ¥å¾ˆå¤šé—®é¢˜ã€‚

é‚£ä¹ˆï¼Œä»€ä¹ˆæ ·çš„åˆ†è¯æ‰æ˜¯å¥½çš„å‘¢ï¼Ÿç›®å‰ä»ç›´è§‰å’Œå·¥ç¨‹å®è·µçš„è§’åº¦æ¥è¯´ï¼š

* é¦–å…ˆï¼Œä¸å¸Œæœ›æœ‰å¤ªå¤šçš„è¯å…ƒï¼ˆæç«¯æƒ…å†µï¼šå­—ç¬¦æˆ–å­—èŠ‚ï¼‰ï¼Œå¦åˆ™åºåˆ—ä¼šå˜å¾—éš¾ä»¥å»ºæ¨¡ã€‚
* å…¶æ¬¡ï¼Œä¹Ÿä¸å¸Œæœ›è¯å…ƒè¿‡å°‘ï¼Œå¦åˆ™å•è¯ä¹‹é—´å°±æ— æ³•å…±äº«å‚æ•°ï¼ˆä¾‹å¦‚ï¼Œ`mother-in-law` å’Œ `father-in-law` åº”è¯¥å®Œå…¨ä¸åŒå—ï¼Ÿï¼‰ï¼Œ
  è¿™å¯¹äºå½¢æ€ä¸°å¯Œçš„è¯­è¨€å°¤å…¶æ˜¯ä¸ªé—®é¢˜ï¼ˆä¾‹å¦‚ï¼Œé˜¿æ‹‰ä¼¯è¯­ã€åœŸè€³å…¶è¯­ç­‰ï¼‰ã€‚
* æ¯ä¸ªè¯å…ƒåº”è¯¥æ˜¯ä¸€ä¸ªåœ¨è¯­è¨€æˆ–ç»Ÿè®¡ä¸Šæœ‰æ„ä¹‰çš„å•ä½ã€‚

## Byte Pair Encoding

> * Byte Pair Encoding çš„è¯¦ç»†ä»‹ç»åœ¨[è¿™é‡Œ](https://wangzhefeng.com/note/2024/10/16/llm-byte-pair-encoder/)
> * [BPE Wiki](https://zh.wikipedia.org/wiki/%E5%AD%97%E8%8A%82%E5%AF%B9%E7%BC%96%E7%A0%81)

å°†å­—èŠ‚å¯¹ç¼–ç (Byte Pair Encoding, BPE)ç®—æ³•åº”ç”¨äºæ•°æ®å‹ç¼©é¢†åŸŸï¼Œç”¨äºç”Ÿæˆå…¶ä¸­ä¸€ä¸ªæœ€å¸¸ç”¨çš„åˆ†è¯å™¨ã€‚
BPE åˆ†è¯å™¨éœ€è¦é€šè¿‡æ¨¡å‹è®­ç»ƒæ•°æ®è¿›è¡Œå­¦ä¹ ï¼Œè·å¾—éœ€è¦åˆ†è¯æ–‡æœ¬çš„ä¸€äº›é¢‘ç‡ç‰¹å¾ã€‚
å­¦ä¹ åˆ†è¯å™¨çš„è¿‡ç¨‹ï¼Œç›´è§‰ä¸Šï¼Œå…ˆå°†æ¯ä¸ªå­—ç¬¦ä½œä¸ºè‡ªå·±çš„è¯å…ƒï¼Œå¹¶ç»„åˆé‚£äº›ç»å¸¸å…±åŒå‡ºç°çš„è¯å…ƒã€‚
æ•´ä¸ªè¿‡ç¨‹å¯ä»¥è¡¨ç¤ºä¸ºï¼š

* **Input(è¾“å…¥)**ï¼šè®­ç»ƒè¯­æ–™åº“ï¼ˆå­—ç¬¦åºåˆ—ï¼‰ï¼›
* ç®—æ³•æ­¥éª¤ï¼š
    - **Step1**ï¼šåˆå§‹åŒ–è¯æ±‡è¡¨ `$V$` ä¸ºå­—ç¬¦çš„é›†åˆï¼›
    - while(å½“ä»ç„¶å¸Œæœ› `$V$` ç»§ç»­å¢é•¿æ—¶):
        - **Step2**ï¼šæ‰¾åˆ° `$V$` ä¸­å…±åŒå‡ºç°æ¬¡æ•°æœ€å¤šçš„å…ƒç´ å¯¹ `$x,x'$`ï¼›
    - **Step3**ï¼šç”¨ä¸€ä¸ªæ–°çš„ç¬¦å· `$xx'$` æ›¿æ¢æ‰€æœ‰ `$x,x'$` çš„å‡ºç°ï¼›
    - **Step4**ï¼šå°† `$xx'$` æ·»åŠ åˆ° `$V$` ä¸­ã€‚

è¿™é‡Œä¸¾ä¸€ä¸ªä¾‹å­ï¼š

1. Input(è¾“å…¥è¯­æ–™)

```python
I = [["the car", "the cat", "the rat"]]
```

è¿™ä¸ªè¾“å…¥è¯­æ–™æ˜¯ä¸‰ä¸ªå­—ç¬¦ä¸²ã€‚

2. Step 1

é¦–å…ˆï¼Œè¦å…ˆæ„å»ºåˆå§‹åŒ–çš„è¯æ±‡è¡¨ `$V$`ï¼Œå°†æ‰€æœ‰çš„å­—ç¬¦ä¸²æŒ‰ç…§å­—ç¬¦è¿›è¡Œåˆ‡åˆ†ï¼Œå¾—åˆ°å¦‚ä¸‹çš„å½¢å¼ï¼š

```python
[['t', 'h', 'e', '$\space$', 'c', 'a', 'r'],
['t', 'h', 'e', '$\space$', 'c', 'a', 't'],
['t', 'h', 'e', '$\space$', 'r', 'a', 't']]
```

å¯¹äºç€ä¸‰ä¸ªåˆ‡åˆ†åçš„é›†åˆæ±‚å…¶å¹¶é›†ï¼Œä»è€Œå¾—åˆ°äº†åˆå§‹çš„è¯æ±‡è¡¨ `$V$` = `['t', 'h', 'e', ' ', 'c', 'a', 'r', 't']`ã€‚

3. Step 2

æ‰¾åˆ° `$V$` ä¸­å…±åŒå‡ºç°æ¬¡æ•°æœ€å¤šçš„å…ƒç´ å¯¹ `$x,x'$`ï¼šæ‰¾åˆ° `$V$` ä¸­å…±åŒå‡ºç°æ¬¡æ•°æœ€å¤šçš„å…ƒç´ å¯¹ `$x,x'$`ï¼Œ
æˆ‘ä»¬å‘ç° `'t'` å’Œ `'h'` æŒ‰ç…§ `'th'` å½¢å¼ä¸€èµ·å‡ºç°äº†ä¸‰æ¬¡ï¼Œ`'h'` å’Œ `'e'` æŒ‰ç…§ `'he'` å½¢å¼ä¸€èµ·å‡ºç°äº†ä¸‰æ¬¡ï¼Œ
æˆ‘ä»¬å¯ä»¥éšæœºé€‰æ‹©å…¶ä¸­ä¸€ç»„ï¼Œå‡è®¾æˆ‘ä»¬é€‰æ‹©äº† `'th'`ã€‚

4. Step 3

ç”¨ä¸€ä¸ªæ–°çš„ç¬¦å· `$xx'$` æ›¿æ¢æ‰€æœ‰ `$x,x'$` çš„å‡ºç°ï¼šå°†ä¹‹å‰çš„åºåˆ—æ›´æ–°å¦‚ä¸‹ï¼š(`'th'` å‡ºç°äº† 3 æ¬¡)

```python
[['th', 'e', '$\sqcup$', 'c', 'a', 'r'], 
['th', 'e', '$\sqcup$', 'c', 'a', 't'],
['th', 'e', '$\sqcup$', 'r', 'a', 't']] 
```

5. Step 4

`$xx'$` æ·»åŠ åˆ° `$V$` ä¸­ï¼šä»è€Œå¾—åˆ°äº†ä¸€æ¬¡æ›´æ–°åçš„è¯æ±‡è¡¨ `$V$` = `['t', 'h', 'e', ' ', 'c', 'a', 'r', 't', 'th']`ã€‚

æ¥ä¸‹æ¥å¦‚æ­¤å¾€å¤ï¼š

`['the', `$$`, 'c', 'a', 'r']`ï¼Œ`['the', `$$`, 'c', 'a', 't']`ï¼Œ`['the', `$$`, 'r', 'a', 't']`ï¼Œ
`'the'` å‡ºç°äº† 3 æ¬¡ï¼›

`['the', `$$`, 'ca', 'r']`ï¼Œ`['the', `$$`, 'ca', 't']`ï¼Œ`['the', `$$`, 'ra', 't']`ï¼Œ
`'ca'` å‡ºç°äº† 2 æ¬¡ã€‚

Unicode çš„é—®é¢˜ï¼š

Unicodeï¼ˆç»Ÿä¸€ç ï¼‰æ˜¯å½“å‰ä¸»æµçš„ä¸€ç§ç¼–ç æ–¹å¼ã€‚å…¶ä¸­è¿™ç§ç¼–ç æ–¹å¼å¯¹BPEåˆ†è¯äº§ç”Ÿäº†ä¸€ä¸ªé—®é¢˜ï¼ˆå°¤å…¶æ˜¯åœ¨å¤šè¯­è¨€ç¯å¢ƒä¸­ï¼‰ï¼Œ
Unicode å­—ç¬¦éå¸¸å¤šï¼ˆå…± 144,697 ä¸ªå­—ç¬¦ï¼‰ã€‚åœ¨è®­ç»ƒæ•°æ®ä¸­æˆ‘ä»¬ä¸å¯èƒ½è§åˆ°æ‰€æœ‰çš„å­—ç¬¦ã€‚ä¸ºäº†è¿›ä¸€æ­¥å‡å°‘æ•°æ®çš„ç¨€ç–æ€§ï¼Œ
å¯ä»¥å¯¹å­—èŠ‚è€Œä¸æ˜¯ Unicode å­—ç¬¦è¿è¡Œ [BPE ç®—æ³•(Wang ç­‰äººï¼Œ2019å¹´)](https://arxiv.org/pdf/1909.03341.pdf)ã€‚
ä»¥ä¸­æ–‡ä¸ºä¾‹ï¼š

`$$\text{ä»Šå¤©} \Rightarrow [x62, x11, 4e, ca]$$`

BPE ç®—æ³•åœ¨è¿™é‡Œçš„ä½œç”¨æ˜¯ä¸ºäº†è¿›ä¸€æ­¥å‡å°‘æ•°æ®çš„ç¨€ç–æ€§ã€‚é€šè¿‡å¯¹å­—èŠ‚çº§åˆ«è¿›è¡Œåˆ†è¯ï¼Œ
å¯ä»¥åœ¨å¤šè¯­è¨€ç¯å¢ƒä¸­æ›´å¥½åœ°å¤„ç† Unicode å­—ç¬¦çš„å¤šæ ·æ€§ï¼Œå¹¶å‡å°‘æ•°æ®ä¸­å‡ºç°çš„ä½é¢‘è¯æ±‡ï¼Œ
æé«˜æ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›ã€‚é€šè¿‡ä½¿ç”¨å­—èŠ‚ç¼–ç ï¼Œå¯ä»¥å°†ä¸åŒè¯­è¨€ä¸­çš„è¯æ±‡ç»Ÿä¸€è¡¨ç¤ºä¸ºå­—èŠ‚åºåˆ—ï¼Œ
ä»è€Œæ›´å¥½åœ°å¤„ç†å¤šè¯­è¨€æ•°æ®ã€‚

## Unigram model

> SentencePiece

ä¸ä»…ä»…æ ¹æ®é¢‘ç‡è¿›è¡Œæ‹†åˆ†ä¸åŒï¼Œä¸€ä¸ªæ›´â€œæœ‰åŸåˆ™â€çš„æ–¹æ³•æ˜¯å®šä¹‰ä¸€ä¸ªç›®æ ‡å‡½æ•°æ¥æ•æ‰ä¸€ä¸ªå¥½çš„åˆ†è¯çš„ç‰¹å¾ï¼Œ
è¿™ç§åŸºäºç›®æ ‡å‡½æ•°çš„åˆ†è¯æ¨¡å‹å¯ä»¥é€‚åº”æ›´å¥½åˆ†è¯åœºæ™¯ï¼ŒUnigram model å°±æ˜¯åŸºäºè¿™ç§åŠ¨æœºæå‡ºçš„ã€‚
ç°åœ¨æè¿°ä¸€ä¸‹ Unigram æ¨¡å‹[(Kudoï¼Œ2018 å¹´)](https://arxiv.org/pdf/1804.10959.pdf)ã€‚

è¿™æ˜¯ SentencePiece å·¥å…·[(Kudoï¼†Richardsonï¼Œ2018 å¹´)](https://aclanthology.org/D18-2012.pdf) æ‰€æ”¯æŒçš„ä¸€ç§åˆ†è¯æ–¹æ³•ï¼Œ
ä¸ BPE ä¸€èµ·ä½¿ç”¨ã€‚å®ƒè¢«ç”¨æ¥è®­ç»ƒ T5 å’Œ Gopher æ¨¡å‹ã€‚ç»™å®šä¸€ä¸ªåºåˆ— `$x_{1:L}$`ï¼Œ
ä¸€ä¸ªåˆ†è¯å™¨ `$T$` æ˜¯ `$p(x_{1:L}) = \prod_{(i,j)\in T}p(x_{i:j})$` çš„ä¸€ä¸ªé›†åˆã€‚
è¿™é‡Œç»™å‡ºä¸€ä¸ªå®ä¾‹ï¼š

* è®­ç»ƒæ•°æ®ï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼š`'ababc'`ï¼›
* åˆ†è¯ç»“æœ `$T= (1, 2), (3, 4), (5, 5)$`ï¼Œå…¶ä¸­ `$V = ab,c$`
* ä¼¼ç„¶å€¼ï¼š`$p(x_{1:L})= 2/3 \cdot 2 / 3 \cdot 1 / 3 = 4/27$`

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œè®­ç»ƒæ•°æ®æ˜¯å­—ç¬¦ä¸² `"ababc"`ã€‚åˆ†è¯ç»“æœ `$T=(1,2),(3,4),(5,5)$` è¡¨ç¤ºå°†å­—ç¬¦ä¸²æ‹†åˆ†æˆä¸‰ä¸ªå­åºåˆ—ï¼š 
`(a,b)`ï¼Œ`(a,b)`ï¼Œ`(c)`ã€‚è¯æ±‡è¡¨ `V=ab,c` è¡¨ç¤ºäº†è®­ç»ƒæ•°æ®ä¸­å‡ºç°çš„æ‰€æœ‰è¯æ±‡ã€‚

ä¼¼ç„¶å€¼ `$p(x_{1:L})$` æ˜¯æ ¹æ® unigram æ¨¡å‹è®¡ç®—å¾—å‡ºçš„æ¦‚ç‡ï¼Œè¡¨ç¤ºè®­ç»ƒæ•°æ®çš„ä¼¼ç„¶åº¦ã€‚
åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæ¦‚ç‡çš„è®¡ç®—ä¸º `$2/3\cdot 2/3 \cdot 1/3=4/27$`ã€‚
è¿™ä¸ªå€¼ä»£è¡¨äº†æ ¹æ® Unigram æ¨¡å‹ï¼Œå°†è®­ç»ƒæ•°æ®åˆ†è¯ä¸ºæ‰€ç»™çš„åˆ†è¯ç»“æœ `$T$` çš„æ¦‚ç‡ã€‚

Unigram æ¨¡å‹é€šè¿‡ç»Ÿè®¡æ¯ä¸ªè¯æ±‡åœ¨è®­ç»ƒæ•°æ®ä¸­çš„å‡ºç°æ¬¡æ•°æ¥ä¼°è®¡å…¶æ¦‚ç‡ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ
`'ab'` åœ¨è®­ç»ƒæ•°æ®ä¸­å‡ºç°äº†ä¸¤æ¬¡ï¼Œ`'c'` å‡ºç°äº†ä¸€æ¬¡ã€‚å› æ­¤ï¼Œæ ¹æ® Unigram æ¨¡å‹çš„ä¼°è®¡ï¼Œ 
`$p(ab)=2/3$`ï¼Œ`$p(c)=1/3$`ã€‚é€šè¿‡å°†å„ä¸ªè¯æ±‡çš„æ¦‚ç‡ç›¸ä¹˜ï¼Œ
æˆ‘ä»¬å¯ä»¥å¾—åˆ°æ•´ä¸ªè®­ç»ƒæ•°æ®çš„ä¼¼ç„¶å€¼ä¸º `$4/27$`ã€‚

ä¼¼ç„¶å€¼çš„è®¡ç®—æ˜¯ Unigram æ¨¡å‹ä¸­é‡è¦çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒç”¨äºè¯„ä¼°åˆ†è¯ç»“æœçš„è´¨é‡ã€‚
è¾ƒé«˜çš„ä¼¼ç„¶å€¼è¡¨ç¤ºè®­ç»ƒæ•°æ®ä¸åˆ†è¯ç»“æœä¹‹é—´çš„åŒ¹é…ç¨‹åº¦è¾ƒé«˜ï¼Œè¿™æ„å‘³ç€è¯¥åˆ†è¯ç»“æœè¾ƒä¸ºå‡†ç¡®æˆ–åˆç†ã€‚

**ç®—æ³•æµç¨‹ï¼š**

* ä»ä¸€ä¸ªâ€œç›¸å½“å¤§â€çš„ç§å­è¯æ±‡è¡¨ `$V$` å¼€å§‹ã€‚
* é‡å¤ä»¥ä¸‹æ­¥éª¤ï¼š
    - ç»™å®š `$V$`ï¼Œä½¿ç”¨ EM ç®—æ³•ä¼˜åŒ– `$p(x)$` å’Œ `$T$`ã€‚
    - è®¡ç®—æ¯ä¸ªè¯æ±‡ `$x \in V$` çš„ `$\text{loss}(x)$`ï¼Œ
      è¡¡é‡å¦‚æœå°† `$x$` ä» `$V$` ä¸­ç§»é™¤ï¼Œä¼¼ç„¶å€¼ä¼šå‡å°‘å¤šå°‘ã€‚
    - æŒ‰ç…§ `$\text{loss}$` è¿›è¡Œæ’åºï¼Œå¹¶ä¿ç•™ `$V$` ä¸­æ’åé å‰çš„ 80% çš„è¯æ±‡ã€‚

è¿™ä¸ªè¿‡ç¨‹æ—¨åœ¨ä¼˜åŒ–è¯æ±‡è¡¨ï¼Œå‰”é™¤å¯¹ä¼¼ç„¶å€¼è´¡çŒ®è¾ƒå°çš„è¯æ±‡ï¼Œä»¥å‡å°‘æ•°æ®çš„ç¨€ç–æ€§ï¼Œå¹¶æé«˜æ¨¡å‹çš„æ•ˆæœã€‚
é€šè¿‡è¿­ä»£ä¼˜åŒ–å’Œå‰ªæï¼Œè¯æ±‡è¡¨ä¼šé€æ¸æ¼”åŒ–ï¼Œä¿ç•™é‚£äº›å¯¹äºä¼¼ç„¶å€¼æœ‰è¾ƒå¤§è´¡çŒ®çš„è¯æ±‡ï¼Œæå‡æ¨¡å‹çš„æ€§èƒ½ã€‚

# æ¨¡å‹æ¶æ„

**è¯­è¨€æ¨¡å‹** çš„å®šä½ä¸ºå¯¹ **è¯å…ƒåºåˆ—** çš„æ¦‚ç‡åˆ†å¸ƒ `$p(x_{1}, \cdots, x_{L})$`ï¼Œ
å·²ç»çœ‹åˆ°è¿™ç§å®šä¹‰éå¸¸ä¼˜é›…ä¸”å¼ºå¤§ï¼ˆé€šè¿‡æç¤º(Prompt)ï¼Œ
è¯­è¨€æ¨¡å‹åŸåˆ™ä¸Šå¯ä»¥å®Œæˆä»»ä½•ä»»åŠ¡ï¼Œæ­£å¦‚ GPT-3 æ‰€ç¤ºï¼‰ã€‚
ç„¶è€Œï¼Œåœ¨å®è·µä¸­ï¼Œå¯¹äºä¸“é—¨çš„ä»»åŠ¡æ¥è¯´ï¼Œé¿å…ç”Ÿæˆæ•´ä¸ªåºåˆ—çš„ç”Ÿæˆæ¨¡å‹å¯èƒ½æ›´é«˜æ•ˆã€‚

ä¸Šä¸‹æ–‡å‘é‡è¡¨å¾(Contextual Embedding) ä½œä¸ºæ¨¡å‹å¤„ç†çš„å…ˆå†³æ¡ä»¶ï¼Œ
å…¶å…³é”®æ˜¯å°†è¯å…ƒåºåˆ—è¡¨ç¤ºä¸ºå“åº”çš„ä¸Šä¸‹æ–‡çš„å‘é‡è¡¨å¾ï¼š

`$$[\text{the, mouse, ate, the, cheese}] \stackrel{\phi}{\Rightarrow} 
\left[
    \left(\begin{array}{c}1 \\ 0.1\end{array}\right),
    \left(\begin{array}{l}0 \\ 1\end{array}\right),
    \left(\begin{array}{l}1 \\ 1\end{array}\right),
    \left(\begin{array}{c}1 \\ -0.1\end{array}\right),
    \left(\begin{array}{c}0 \\ -1\end{array}\right)
\right]$$`

æ­£å¦‚åç§°æ‰€ç¤ºï¼Œè¯å…ƒçš„ä¸Šä¸‹æ–‡å‘é‡è¡¨å¾å–å†³äºå…¶ä¸Šä¸‹æ–‡ï¼ˆå‘¨å›´çš„å•è¯ï¼‰ã€‚
ä¾‹å¦‚ï¼Œè€ƒè™‘ `mouse` çš„å‘é‡è¡¨ç¤ºéœ€è¦å…³æ³¨åˆ°å‘¨å›´æŸä¸ªçª—å£å¤§å°çš„å…¶ä»–å•è¯ã€‚

* ç¬¦å·è¡¨ç¤ºï¼šå°† `$\phi: V^{L} \rightarrow \mathbb{R}^{d\times L}$` å®šä¹‰ä¸ºåµŒå…¥å‡½æ•°ï¼ˆç±»ä¼¼äºåºåˆ—çš„ç‰¹å¾æ˜ å°„ï¼Œæ˜ å°„ä¸ºå¯¹åº”çš„å‘é‡è¡¨ç¤ºï¼‰ï¼›
* å¯¹äºè¯å…ƒåºåˆ— `$x_{1:L} = [x_{1}, \cdots, x_{L}]$`ï¼Œ`$\phi$` ç”Ÿæˆä¸Šä¸‹æ–‡å‘é‡è¡¨å¾ `$\phi(x_{1:L})$`ã€‚

**å¸¸è§è¯­è¨€æ¨¡å‹çš„åˆ†ç±»ï¼š**

å¯¹äºè¯­è¨€æ¨¡å‹æ¥è¯´ï¼Œæœ€åˆçš„èµ·æºæ¥è‡ªäº Transformer æ¨¡å‹ï¼Œè¿™ä¸ªæ¨¡å‹æ˜¯ **ç¼–ç -è§£ç (Encoder-Decoder)** çš„æ¶æ„ã€‚
ä½†æ˜¯å½“å‰å¯¹äºè¯­è¨€æ¨¡å‹çš„åˆ†ç±»ï¼Œå°†è¯­è¨€æ¨¡å‹åˆ†ä¸ºä¸‰ä¸ªç±»å‹ï¼š

* ç¼–ç ç«¯(Encoder-Only)
* è§£ç ç«¯(Decoder-Only)
* ç¼–ç -è§£ç ç«¯(Encoder-Decoder)

## Encoder-Only æ¶æ„

ç¼–ç ç«¯æ¶æ„çš„è‘—åçš„æ¨¡å‹å¦‚ **BERT**ã€**RoBERTa** ç­‰ã€‚è¿™äº›è¯­è¨€æ¨¡å‹ç”Ÿæˆä¸Šä¸‹æ–‡å‘é‡è¡¨å¾ï¼Œ
ä½†ä¸èƒ½ç›´æ¥ç”¨äºç”Ÿæˆæ–‡æœ¬ã€‚å¯ä»¥è¡¨ç¤ºä¸º `$x_{1:L} \Rightarrow \phi(x_{1:L})$`ã€‚
è¿™äº›ä¸Šä¸‹æ–‡å‘é‡è¡¨å¾é€šå¸¸ç”¨äº **åˆ†ç±»ä»»åŠ¡**ï¼Œä¹Ÿè¢«ç§°ä¸º **è‡ªç„¶è¯­è¨€ç†è§£ä»»åŠ¡(NLU)**ï¼Œä»»åŠ¡å½¢å¼æ¯”è¾ƒç®€å•ã€‚

> ä¸‹é¢ä»¥æƒ…æ„Ÿåˆ†ç±»/è‡ªç„¶è¯­è¨€æ¨ç†ä»»åŠ¡ä¸¾ä¾‹ï¼š
> 
> * **æƒ…æ„Ÿåˆ†æ** è¾“å…¥ä¸è¾“å‡ºå½¢å¼ï¼š
> 
> ```
> [[CLS], "ä»–ä»¬", "ç§»åŠ¨", "è€Œ", "å¼ºå¤§"] => "æ­£é¢æƒ…ç»ª"
> ```
> 
> * **è‡ªç„¶è¯­è¨€æ¨ç†** è¾“å…¥ä¸è¾“å‡ºå½¢å¼ï¼š
> 
> ```
> [[CLS], "æ‰€æœ‰", "åŠ¨ç‰©", "éƒ½", "å–œæ¬¢", "åƒ", "é¥¼å¹²", "å“¦"] => "è•´å«"
> ```

Encoder-Only æ¶æ„è¯­è¨€æ¨¡å‹ä¼˜ç¼ºç‚¹ï¼š

* è¯¥æ¶æ„çš„ **ä¼˜åŠ¿** æ˜¯ï¼š**å¯¹äºæ–‡æœ¬çš„ä¸Šä¸‹æ–‡ä¿¡æ¯æœ‰æ›´å¥½çš„ç†è§£**ï¼Œå› æ­¤è¯¥æ¨¡å‹æ¶æ„æ‰ä¼šå¤šç”¨äºè‡ªç„¶è¯­è¨€ç†è§£ä»»åŠ¡ã€‚
  å³å¯¹äºæ¯ä¸ª `$x_{i}$`ï¼Œä¸Šä¸‹æ–‡å‘é‡è¡¨å¾å¯ä»¥åŒå‘åœ°ä¾èµ–äºå·¦ä¾§ä¸Šä¸‹æ–‡ `$(x_{1:i-1})$` å’Œ å³ä¾§ä¸Šä¸‹æ–‡ `$(x_{i+1:L})$`ã€‚
* **ç¼ºç‚¹** åœ¨äº **ä¸èƒ½è‡ªç„¶åœ°ç”Ÿæˆå®Œæ•´æ–‡æœ¬ï¼Œä¸”éœ€è¦æ›´å¤šçš„ç‰¹å®šè®­ç»ƒç›®æ ‡**ï¼ˆå¦‚æ©ç è¯­è¨€å»ºæ¨¡ï¼‰ã€‚

## Decoder-Only æ¶æ„

è§£ç å™¨æ¶æ„çš„è‘—åæ¨¡å‹å°±æ˜¯å¤§åé¼é¼çš„ GPT ç³»åˆ—æ¨¡å‹ï¼Œè¿™äº›å°±æ˜¯å¸¸è§çš„è‡ªå›å½’è¯­è¨€æ¨¡å‹ã€‚
ç»™å®šä¸€ä¸ªæç¤º `$x_{1:i}$`ï¼Œå®ƒä»¬å¯ä»¥ç”Ÿæˆä¸Šä¸‹æ–‡å‘é‡è¡¨å¾ï¼Œå¹¶å¯¹ä¸‹ä¸€ä¸ªè¯å…ƒ `$x_{i+1}$`ï¼ˆä»¥åŠé€’å½’åœ°ï¼Œ
æ•´ä¸ªå®Œæˆ `$x_{i+1:L}$`ï¼‰ ç”Ÿæˆä¸€ä¸ªæ¦‚ç‡åˆ†å¸ƒ `$x_{1:i} \Rightarrow \phi(x_{1:i}), p(x_{i+1}|x_{1:i})$`ã€‚
ä»¥è‡ªåŠ¨è¡¥å…¨ä»»åŠ¡æ¥è¯´ï¼Œè¾“å…¥ä¸è¾“å‡ºçš„å½¢å¼ä¸ºï¼š

```
[[CLS], "ä»–ä»¬", "ç§»åŠ¨", "è€Œ"] => "å¼ºå¤§"
```

Decoder-Only æ¶æ„è¯­è¨€æ¨¡å‹ä¼˜ç¼ºç‚¹ï¼š

* ä¸ç¼–ç ç«¯æ¶æ„æ¯”ï¼šå…¶ **ä¼˜ç‚¹** ä¸ºèƒ½å¤Ÿè‡ªç„¶åœ°ç”Ÿæˆå®Œæˆæ–‡æœ¬ï¼Œæœ‰ç®€å•çš„è®­ç»ƒç›®æ ‡ï¼ˆæœ€å¤§ä¼¼ç„¶ï¼‰ï¼›
* **ç¼ºç‚¹** ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œå¯¹äºæ¯ä¸ª `$x_{i}$`ï¼Œä¸Šä¸‹æ–‡å‘é‡è¡¨å¾åªèƒ½å•å‘åœ°ä¾èµ–äºå·¦ä¾§ä¸Šä¸‹æ–‡ `$(x_{1:i-1})$`ã€‚

## Encoder-Decoder æ¶æ„

ç¼–ç -è§£ç ç«¯æ¶æ„å°±æ˜¯æœ€åˆçš„ **Transformer** æ¨¡å‹ï¼Œå…¶ä»–çš„è¿˜æœ‰å¦‚ **BART**ã€**T5** ç­‰æ¨¡å‹ã€‚
è¿™äº›æ¨¡å‹åœ¨æŸç§ç¨‹åº¦ä¸Šç»“åˆäº†ä¸¤è€…çš„ä¼˜ç‚¹ï¼šå®ƒä»¬å¯ä»¥ä½¿ç”¨åŒå‘ä¸Šä¸‹æ–‡å‘é‡è¡¨å¾æ¥å¤„ç†è¾“å…¥ `$x_{1:L}$`ï¼Œ
å¹¶ä¸”å¯ä»¥ç”Ÿæˆè¾“å‡º `$y_{1:L}$`ã€‚å¯ä»¥å…¬å¼åŒ–ä¸ºï¼š

`$$x_{1:L} \Rightarrow \phi(x_{1:L}), p(y_{1:L}|\phi(x_{1:L}))$$`

> ä»¥ **è¡¨æ ¼åˆ°æ–‡æœ¬ç”Ÿæˆä»»åŠ¡** ä¸ºä¾‹ï¼Œå…¶è¾“å…¥å’Œè¾“å‡ºçš„å¯ä»¥è¡¨ç¤ºä¸ºï¼š
> 
> ```
> ["åç§°:", "æ¤ç‰©", |, "ç±»å‹:", "èŠ±å‰", "å•†åº—"] => ["èŠ±å‰", "æ˜¯", "ä¸€", "ä¸ª", "å•†åº—"]
> ```

Encoder-Decoder æ¶æ„è¯­è¨€æ¨¡å‹ä¼˜ç¼ºç‚¹ï¼š

* è¯¥æ¨¡å‹å…·æœ‰ç¼–ç ç«¯ï¼Œè§£ç ç«¯ä¸¤ä¸ªæ¶æ„çš„å…±åŒçš„ **ä¼˜ç‚¹**ï¼Œå¯¹äºæ¯ä¸ª `$x_{i}$`ï¼Œ
  ä¸Šä¸‹æ–‡å‘é‡è¡¨å¾å¯ä»¥åŒå‘åœ°ä¾èµ–äºå·¦ä¾§ä¸Šä¸‹æ–‡ `$(x_{1:i-1})$` å’Œå³ä¾§ä¸Šä¸‹æ–‡ `$(x_{1+1:L})$`ï¼Œ
  å¯ä»¥è‡ªç”±åœ°ç”Ÿæˆæ–‡æœ¬æ•°æ®ï¼›
* ç¼ºç‚¹å°±æ˜¯éœ€è¦æ›´å¤šçš„ç‰¹å®šè®­ç»ƒç›®æ ‡ã€‚

# è¯­è¨€æ¨¡å‹ç†è®º

## åŸºç¡€æ¶æ„

é¦–å…ˆï¼Œéœ€è¦å°†è¯å…ƒåºåˆ—è½¬æ¢ä¸ºåºåˆ—çš„å‘é‡å½¢å¼ã€‚
`EmbedToken` å‡½æ•°é€šè¿‡åœ¨åµŒå…¥çŸ©é˜µ `$E\in \mathbb{R}^{|v|\times d}$` ä¸­æŸ¥æ‰¾æ¯ä¸ªè¯å…ƒæ‰€å¯¹åº”çš„å‘é‡ï¼Œ
è¯¥å‘é‡çš„å…·ä½“å€¼æ˜¯ä»æ•°æ®ä¸­å­¦ä¹ çš„å‚æ•°ï¼š

`$$\text{def EmbedToken}(x_{1:L}:V^{L}) \rightarrow \mathbb{R}^{d \times L}$$`

* å°†åºåˆ— `$x_{1:L}$` ä¸­çš„æ¯ä¸ªè¯å…ƒ `$x_{i}$` è½¬æ¢ä¸ºå‘é‡ï¼Œè¿”å› `$[E_{x_{1}}, \cdots, E_{x_{L}}]$`

ä¸Šé¢çš„è¯åµŒå…¥(Embedding)æ˜¯ä¼ ç»Ÿçš„è¯åµŒå…¥ï¼Œå‘é‡å†…å®¹ä¸ä¸Šä¸‹æ–‡æ— å…³ã€‚
è¿™é‡Œå®šä¹‰ä¸€ä¸ªæŠ½è±¡çš„ `SequenceModel` å‡½æ•°ï¼Œå®ƒæ¥å—è¿™äº›ä¸Šä¸‹æ–‡æ— å…³çš„åµŒå…¥ï¼Œ
å¹¶å°†å®ƒä»¬æ˜ å°„ä¸ºä¸Šä¸‹æ–‡ç›¸å…³çš„åµŒå…¥ã€‚

`$$\text{def SequenceModel}(x_{1:L}:\mathbb{R}^{d\times L}) \rightarrow \mathbb{R}^{d\times L}$$`

* é’ˆå¯¹åºåˆ— `$x_{1:L}$` ä¸­çš„æ¯ä¸ªå…ƒç´  `$x_{i}$` è¿›è¡Œå¤„ç†ï¼Œè€ƒè™‘å…¶ä»–å…ƒç´ ï¼›
* æŠ½è±¡å®ç°ï¼šFeedForwardSequenceModelã€SequenceRNNã€TransformerBlockã€‚

æœ€ç®€å•ç±»å‹çš„åºåˆ—æ¨¡å‹åŸºäºå‰é¦ˆç½‘ç»œï¼ˆBengio ç­‰äººï¼Œ2003ï¼‰ï¼Œåº”ç”¨äºå›ºå®šé•¿åº¦çš„ä¸Šä¸‹æ–‡ï¼Œ
å°±åƒ N-Gram æ¨¡å‹ä¸€æ ·ï¼Œå‡½æ•°çš„å®ç°å¦‚ä¸‹ï¼š

`$$\text{def FeedForwardSequenceModel}(x_{1:L}:\mathbb{R}^{d\times L}) \rightarrow \mathbb{R}^{d\times L}$$`

* é€šè¿‡æŸ¥çœ‹æœ€å `$n$` ä¸ªå…ƒç´ å¤„ç†åºåˆ— `$x_{1:L}$` ä¸­çš„æ¯ä¸ªå…ƒç´  `$x_{i}$`ï¼Œ
  å¯¹äºæ¯ä¸ª `$i=1,\cdots, L$`ï¼Œè®¡ç®— `$h_{i}=\text{FeedForward}(x_{i-(n-1)}, \cdots, x_{i})$`ï¼Œ
  è¿”å› `$[h_{1}, \cdots, h_{L}]$`ã€‚

## RNN

ç¬¬ä¸€ä¸ªçœŸæ­£çš„åºåˆ—æ¨¡å‹æ˜¯é€’å½’ç¥ç»ç½‘ç»œ(RNN)ï¼Œå®ƒæ˜¯ä¸€ç±»æ¨¡å‹ï¼ŒåŒ…æ‹¬ç®€å•çš„ RNNã€LSTM å’Œ GRUã€‚
åŸºæœ¬å½¢å¼çš„ RNN é€šè¿‡é€’å½’åœ°è®¡ç®—ä¸€ç³»åˆ—éšè—çŠ¶æ€æ¥è¿›è¡Œè®¡ç®—ã€‚

`$$\text{def SequenceRNN}(x:\mathbb{R}^{d\times L}) \rightarrow \mathbb{R}^{d\times L}$$`

* ä»å·¦åˆ°å³å¤„ç†åºåˆ— `$x_{1}, \cdots, x_{L}$`ï¼Œå¹¶é€’å½’è®¡ç®—å‘é‡ `$h_{1}, \cdots, h_{L}$`ã€‚
  å¯¹äº `$i=1,\cdots, L$`ï¼Œè®¡ç®— `$h_{i}=\text{RNN}(h_{i-1}, x_{i})$`ï¼Œè¿”å› `$[h_{1}, \cdots, h_{L}]$`ã€‚

å®é™…å®Œæˆå·¥ä½œçš„æ¨¡å—æ˜¯ RNNï¼Œç±»ä¼¼äºæœ‰é™çŠ¶æ€æœºï¼Œå®ƒæ¥æ”¶å½“å‰çŠ¶æ€ `$h$`ã€æ–°è§‚æµ‹å€¼ `$x$`ï¼Œå¹¶è¿”å›æ›´æ–°åçš„çŠ¶æ€ï¼š

`$$\text{def RNN}(h:\mathbb{R}^{d}, x:\mathbb{R}^{d}) \rightarrow \mathbb{R}^{d}$$`

* æ ¹æ®æ–°çš„è§‚æµ‹å€¼ `$x$` æ›´æ–°éšè—çŠ¶æ€ `$h$`ï¼›
* æŠ½è±¡å®ç°ï¼šSimpleRNNã€LSTMã€GRUã€‚

æœ‰ä¸‰ç§æ–¹æ³•å¯ä»¥å®ç° RNNã€‚æœ€æ—©çš„ RNN æ˜¯ç®€å• RNNï¼ˆElmanï¼Œ1990ï¼‰ï¼Œ
å®ƒå°† `$h$` å’Œ `$x$` çš„çº¿æ€§ç»„åˆé€šè¿‡é€å…ƒç´ éçº¿æ€§å‡½æ•° `$\sigma$`ã€‚
ä¾‹å¦‚ï¼Œé€»è¾‘å‡½æ•° `$\sigma(z)=(1+e-z)-1$`ï¼‰ï¼Œ
æˆ–æ›´ç°ä»£åœ° ReLU å‡½æ•° `$\sigma(z)=\text{max}(0, z)$` è¿›è¡Œå¤„ç†ã€‚

`$$\text{def SimpleRNN}(h:\mathbb{R}^{d}, x:\mathbb{R}^{d}) \rightarrow \mathbb{R}^{d}$$`

* é€šè¿‡ç®€å•çš„çº¿æ€§å˜æ¢å’Œéçº¿æ€§å‡½æ•°æ ¹æ®æ–°çš„è§‚æµ‹å€¼ `$x$` æ›´æ–°éšè—çŠ¶æ€ `$h$`ã€‚
  è¿”å› `$\sigma(Uh+Vx+b)$`ã€‚

æ­£å¦‚å®šä¹‰çš„ RNN åªä¾èµ–äºè¿‡å»ï¼Œä½†å¯ä»¥é€šè¿‡å‘åè¿è¡Œå¦ä¸€ä¸ª RNN æ¥ä½¿å…¶ä¾èµ–äºæœªæ¥ä¸¤ä¸ªã€‚
è¿™äº›æ¨¡å‹è¢« ELMo å’Œ ULMFiT ä½¿ç”¨ã€‚

`$$\text{def BidirectionalSequenceRNN}(x_{1:L}:\mathbb{R}^{d\times L}) \rightarrow \mathbb{R}^{2d\times L}$$`

* åŒæ—¶ä»å·¦åˆ°å³å’Œä»å³åˆ°å·¦å¤„ç†åºåˆ—ï¼›
* è®¡ç®—ä»å·¦åˆ°å³ï¼š`$\text{SequenceRNN}(x_{1}, \cdots, x_{L}) \rightarrow [h_{\rightarrow 1}, \cdots, h_{\rightarrow L}]$`ï¼›
* è®¡ç®—ä»å³åˆ°å·¦ï¼š`$\text{SequenceRNN}(x_{1}, \cdots, x_{L}) \rightarrow [h_{\leftarrow 1}, \cdots, h_{\leftarrow L}]$`ï¼›
* è¿”å› `$[h_{\rightarrow 1}, h_{\leftarrow 1}, \cdots, h_{\rightarrow L}, h_{\leftarrow L}]$`ã€‚

## Transformer

Transformer æ˜¯çœŸæ­£æ¨åŠ¨å¤§å‹è¯­è¨€æ¨¡å‹å‘å±•çš„åºåˆ—æ¨¡å‹ã€‚

### Attention

Transformer çš„å…³é”®æ˜¯ Attention(æ³¨æ„æœºåˆ¶)ï¼Œ
è¿™ä¸ªæœºåˆ¶æ—©åœ¨æœºå™¨ç¿»è¯‘ä¸­å°±è¢«å¼€å‘å‡ºæ¥äº†ï¼ˆBahdananu ç­‰äººï¼Œ2017ï¼‰ã€‚
å¯ä»¥å°†æ³¨æ„åŠ›è§†ä¸ºä¸€ä¸ª â€œè½¯â€ æŸ¥æ‰¾è¡¨ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªæŸ¥è¯¢ `$y$`ï¼Œ
æˆ‘ä»¬å¸Œæœ›å°†å…¶ä¸åºåˆ— `$x_{1:L}=[x_{1}, \cdots, x_{L}]$`â€‹ çš„æ¯ä¸ªå…ƒç´ è¿›è¡ŒåŒ¹é…ã€‚
å¯ä»¥é€šè¿‡çº¿æ€§å˜æ¢å°†æ¯ä¸ª `$x_{i}$` è§†ä¸ºè¡¨ç¤ºé”®å€¼å¯¹ï¼š

`$$(W_{\text{key}}x_{i}):(W_{\text{value}}x_{i})$$`

å¹¶é€šè¿‡å¦ä¸€ä¸ªçº¿æ€§å˜æ¢å½¢æˆæŸ¥è¯¢ï¼š

`$$W_{\text{query}}y$$`

å¯ä»¥å°† Key å’Œ Query è¿›è¡Œæ¯”è¾ƒï¼Œå¾—åˆ°ä¸€ä¸ªåˆ†æ•°ï¼š

`$$\text{score}_{i} = x_{i}^{T}W_{\text{key}}^{T}W_{\text{query}}y, i=1,\cdots,L$$`

è¿™äº›åˆ†æ•°å¯ä»¥è¿›è¡ŒæŒ‡æ•°åŒ–å’Œå½’ä¸€åŒ–ï¼Œå½¢æˆå…³äºè¯å…ƒä½ç½® `$1, \cdots, L$` çš„æ¦‚ç‡åˆ†å¸ƒï¼š

`$$[\alpha_{1}, \cdots, \alpha_{L}] = \text{Softmax}([\text{score}_{1}, \cdots, \text{score}_{L}])$$`

ç„¶åæœ€ç»ˆçš„è¾“å‡ºæ˜¯åŸºäºå€¼å¾—åŠ æƒç»„åˆï¼š

`$$\sum_{i=1}^{L}\alpha_{i}(\text{W}_{value}x_{i})$$`

å¯ä»¥ç”¨çŸ©é˜µå½¢å¼ç®€æ´åœ°è¡¨ç¤ºæ‰€æœ‰è¿™äº›å†…å®¹ï¼š

`$$\text{def Attention}(x_{1:L}:\mathbb{R}^{d\times L}, y:\mathbb{R}^{d}) \rightarrow \mathbb{R}^{d}:$$`

* é€šè¿‡å°†å…¶ä¸æ¯ä¸ª `$x_{i}$` è¿›è¡Œæ¯”è¾ƒæ¥å¤„ç† `$y$`ï¼›
* è¿”å› `$W_{\text{value}}x_{1:L}\text{Softmax}\Bigg(\frac{x_{1:L}^{T}W_{\text{key}}^{T}W_{\text{query}}y}{\sqrt{d}}\Bigg)$`

å¯ä»¥å°†æ³¨æ„åŠ›çœ‹ä½œæ˜¯å…·æœ‰å¤šä¸ªæ–¹é¢ï¼ˆä¾‹å¦‚ï¼Œå¥æ³•ã€è¯­ä¹‰ï¼‰çš„åŒ¹é…ã€‚ä¸ºäº†é€‚åº”è¿™ä¸€ç‚¹ï¼Œ
æˆ‘ä»¬å¯ä»¥åŒæ—¶ä½¿ç”¨å¤šä¸ªæ³¨æ„åŠ›å¤´ï¼Œå¹¶ç®€å•åœ°ç»„åˆå®ƒä»¬çš„è¾“å‡ºã€‚

`$$\text{def MultiHeadedAttention}(x_{1:L}:\mathbb{R}^{d\times L}, y:\mathbb{R}^{d}) \rightarrow \mathbb{R}^{d}$$`

* é€šè¿‡å°†å…¶ä¸æ¯ä¸ª `$x_{i}$` ä¸ nheads ä¸ªæ–¹é¢è¿›è¡Œæ¯”è¾ƒï¼Œå¤„ç† `$y$`ï¼›
* è¿”å› `$W_{\text{output}}[\text{Attention}_{1}(x_{1:L},y), \cdots, \text{Attention}_{\text{nheads}}(x_{1:L},y)]$`ã€‚

å¯¹äº Self-Attentionï¼Œå°†ç”¨ `$x_{i}$` æ›¿æ¢ `$y$` ä½œä¸ºæŸ¥è¯¢å‚æ•°æ¥äº§ç”Ÿï¼Œ
å…¶æœ¬è´¨ä¸Šå°±æ˜¯å°†è‡ªèº«çš„ `$x_{i}$` å¯¹å¥å­çš„å…¶ä»–ä¸Šä¸‹æ–‡å†…å®¹è¿›è¡Œ Attention çš„è¿ç®—ï¼š

`$$\text{def SelfAttention}(x_{1:L}:\mathbb{R}^{d\times L}) \rightarrow \mathbb{R}^{d\times L}$$`

è‡ªæ³¨æ„åŠ›ä½¿å¾—æ‰€æœ‰çš„è¯å…ƒéƒ½å¯ä»¥â€œç›¸äº’é€šä¿¡â€ï¼Œè€Œå‰é¦ˆå±‚æä¾›è¿›ä¸€æ­¥çš„è¿æ¥ï¼š

`$$\text{def FeedForward}(x_{1:L}:\mathbb{R}^{d\times L}) \rightarrow \mathbb{R}^{d\times L}$$`

* ç‹¬ç«‹å¤„ç†æ¯ä¸ªè¯å…ƒï¼›
* å¯¹äº `$i=1,\cdots,L$`ï¼Œè®¡ç®— `$y_{i}=W_{2}\text{max}(W_{1}x_{i}+b_{1}, 0) + b_{2}$`ï¼š
* è¿”å›ï¼š`$[y_{1}, \cdots, y_{L}]$`ã€‚

åŸåˆ™ä¸Šï¼Œå¯ä»¥åªéœ€å°† FeedForward `$\cdot$` SelfAttention åºåˆ—æ¨¡å‹è¿­ä»£ 96 æ¬¡ä»¥æ„å»º GPT-3ï¼Œ
ä½†æ˜¯é‚£æ ·çš„ç½‘ç»œå¾ˆéš¾ä¼˜åŒ–ï¼ˆåŒæ ·å—åˆ°æ²¿æ·±åº¦æ–¹å‘çš„æ¢¯åº¦æ¶ˆå¤±é—®é¢˜çš„å›°æ‰°ï¼‰ã€‚å› æ­¤ï¼Œå¿…é¡»è¿›è¡Œä¸¤ä¸ªæ‰‹æ®µï¼Œ
ä»¥ç¡®ä¿ç½‘ç»œå¯è®­ç»ƒã€‚

### æ®‹å·®è¿æ¥å’Œå½’ä¸€åŒ–

* æ®‹å·®è¿æ¥

è®¡ç®—æœºè§†è§‰ä¸­çš„ä¸€ä¸ªæŠ€å·§æ˜¯æ®‹å·®è¿æ¥(ResNet)ã€‚ä¸ä»…åº”ç”¨æŸä¸ªå‡½æ•° `$f$`ï¼š

`$$f(x_{1:L})$$`

è€Œæ˜¯æ·»åŠ ä¸€ä¸ªæ®‹å·®ï¼ˆè·³è·ƒï¼‰è¿æ¥ï¼Œä»¥ä¾¿å¦‚æœ `$f$` çš„æ¢¯åº¦æ¶ˆå¤±ï¼Œæ¢¯åº¦ä»ç„¶å¯ä»¥é€šè¿‡ `$x_{1:L}$` è¿›è¡Œè®¡ç®—ï¼š

`$$x_{1:L}+f(x_{1:L})$$`

* å±‚å½’ä¸€åŒ–(Layer Norm)

å¦ä¸€ä¸ªæŠ€å·§æ˜¯å±‚å½’ä¸€åŒ–ï¼Œå®ƒæ¥æ”¶ä¸€ä¸ªå‘é‡å¹¶ç¡®ä¿å…¶å…ƒç´ ä¸ä¼šå¤ªå¤§ï¼š

`$$\text{def LayerNorm}(x_{1:L}:\mathbb{R}^{d\times L}) \rightarrow \mathbb{R}^{d\times L}$$`

* ä½¿å¾—æ¯ä¸ª `$x_{i}$` å³ä¸å¤ªå¤§é¡µä¸å¤ªå°ï¼›

é¦–å…ˆé¡¶ä¸€ä¸ªé€‚é…å™¨å‡½æ•°ï¼Œè¯¥å‡½æ•°æ¥å—ä¸€ä¸ªåºåˆ—æ¨¡å‹ `$f$` å¹¶ä½¿å…¶â€œé²æ£’â€ï¼š

`$$\text{def AddNorm}(f: (\mathbb{R}^{d\times L} \rightarrow \mathbb{R}^{d\times L}), x_{1:L}:\mathbb{R}^{d\times L}):$$`

* å®‰å…¨åœ°å°† `$f$` åº”ç”¨äº `$x_{1:L}$`ï¼›
* è¿”å›ï¼š`$\text{LayerNorm}(x_{1:L} + f(x_{1:L}))$`ã€‚

æœ€åï¼Œå¯ä»¥ç®€æ´åœ°å®šä¹‰ Transformer block å¦‚ä¸‹ï¼š

`$$\text{def TransformerBlock}(x_{1:L}:\mathbb{R}^{d\times L}) \rightarrow \mathbb{R}^{d\times L}:$$`

* å¤„ç†ä¸Šä¸‹æ–‡ä¸­åœ°æ¯ä¸ªå…ƒç´  `$x_{i}$`ï¼›
* è¿”å› `$\text{AddNorm}(\text{FeedForward}, \text{AddNorm}(\text{SelfAttention}, x_{1:L}))$`ã€‚

### ä½ç½®åµŒå…¥

æœ€åå¯¹ç›®å‰è¯­è¨€æ¨¡å‹çš„ä½ç½®åµŒå…¥è¿›è¡Œè®¨è®ºã€‚å¯èƒ½å·²ç»æ³¨æ„åˆ°ï¼Œæ ¹æ®å®šä¹‰ï¼Œè¯å…ƒçš„åµŒå…¥ä¸ä¾èµ–äºå…¶åœ¨åºåˆ—ä¸­çš„ä½ç½®ï¼Œ
å› æ­¤ä¸¤ä¸ªå¥å­ä¸­çš„ `mouse` å°†å…·æœ‰ç›¸åŒçš„åµŒå…¥ï¼Œä»è€Œåœ¨å¥å­ä½ç½®çš„è§’åº¦å¿½ç•¥äº†ä¸Šä¸‹æ–‡çš„ä¿¡æ¯ï¼Œè¿™æ˜¯ä¸åˆç†çš„ã€‚

```
[ğ—ğ—ğ–¾,ğ—†ğ—ˆğ—ğ—Œğ–¾,ğ–ºğ—ğ–¾,ğ—ğ—ğ–¾,ğ–¼ğ—ğ–¾ğ–¾ğ—Œğ–¾]
[ğ—ğ—ğ–¾,ğ–¼ğ—ğ–¾ğ–¾ğ—Œğ–¾,ğ–ºğ—ğ–¾,ğ—ğ—ğ–¾,ğ—†ğ—ˆğ—ğ—Œğ–¾]
```

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå°†ä½ç½®ä¿¡æ¯æ·»åŠ åˆ°åµŒå…¥ä¸­ï¼š

`$$\text{def EmbedTokenWithPosition}(x_{1:L}:\mathbb{R}^{d\times L})$$`

* æ·»åŠ ä½ç½®ä¿¡æ¯ï¼›
* å®šä¹‰ä½ç½®åµŒå…¥ï¼š
    * å¶æ•°ç»´åº¦ï¼š`$P_{i, 2j} = \sin(i/10000^{2j/\text{dmodel}})$`
    * å¥‡æ•°ç»´åº¦ï¼š`$P_{i, 2j+1} = \cos(i/10000^{2j/\text{dmodel}})$`
* è¿”å›ï¼š`$[x_{1} + P_{1}, \cdots, x_{L}+P_{L}]$`ã€‚

ä¸Šé¢çš„å‡½æ•°ä¸­ï¼Œ`$i$` è¡¨ç¤ºå¥å­ä¸­è¯å…ƒçš„ä½ç½®ï¼Œ`$j$` è¡¨ç¤ºè¯¥è¯å…ƒçš„å‘é‡è¡¨ç¤ºç»´åº¦ä½ç½®ã€‚

## GPT-3

åœ¨æ‰€æœ‰ç»„ä»¶å°±ä½åï¼Œç°åœ¨å¯ä»¥ç®€è¦åœ°å®šä¹‰ GPT-3 æ¶æ„ï¼Œåªéœ€å°† Transformer å—å †å  96 æ¬¡å³å¯ï¼š

`$$\text{GPT-3}(x_{1:L}) = \text{TransformerBlock}^{96}(\text{EmbedTokenWithPosition}(x_{1:L}))$$`

æ¶æ„çš„å½¢çŠ¶ï¼ˆå¦‚ä½•åˆ†é… 1750 äº¿ä¸ªå‚æ•°ï¼‰ï¼š

* éšè—çŠ¶æ€çš„ç»´åº¦ï¼š`$\text{dmodel}=12288$`
* ä¸­é—´å‰é¦ˆå±‚çš„ç»´åº¦ï¼š`$\text{dff}=4 \text{dmodel}$`
* æ³¨æ„å¤´çš„æ•°é‡ï¼š`$\text{nheads}=96$`
* ä¸Šä¸‹æ–‡é•¿åº¦ï¼š`$L=2048$`

è¿™äº›å†³ç­–æœªå¿…æ˜¯æœ€ä¼˜çš„ã€‚Levineç­‰äººï¼ˆ2020ï¼‰æä¾›äº†ä¸€äº›ç†è®ºä¸Šçš„è¯æ˜ï¼Œ
è¡¨æ˜ GPT-3 çš„æ·±åº¦å¤ªæ·±ï¼Œè¿™ä¿ƒä½¿äº†æ›´æ·±ä½†æ›´å®½çš„ Jurassic æ¶æ„çš„è®­ç»ƒã€‚

ä¸åŒç‰ˆæœ¬çš„ Transformer ä¹‹é—´å­˜åœ¨é‡è¦ä½†è¯¦ç»†çš„å·®å¼‚ï¼š

* å±‚å½’ä¸€åŒ–â€œåå½’ä¸€åŒ–â€ï¼ˆåŸå§‹ Transformer è®ºæ–‡ï¼‰ä¸â€œå…ˆå½’ä¸€åŒ–â€ï¼ˆGPT-2ï¼‰ï¼Œè¿™å½±å“äº†è®­ç»ƒçš„ç¨³å®šæ€§ï¼ˆDavisç­‰äººï¼Œ2021ï¼‰ã€‚
* åº”ç”¨äº†ä¸¢å¼ƒï¼ˆDropoutï¼‰ä»¥é˜²æ­¢è¿‡æ‹Ÿåˆã€‚
* GPT-3 ä½¿ç”¨äº†sparse Transformerï¼ˆç¨€é‡Š Transformerï¼‰æ¥å‡å°‘å‚æ•°æ•°é‡ï¼Œå¹¶ä¸ç¨ å¯†å±‚äº¤é”™ä½¿ç”¨ã€‚
* æ ¹æ® Transformer çš„ç±»å‹ï¼ˆEncdoer-Only, Decoder-Only, Encdoer-Decoderï¼‰ï¼Œä½¿ç”¨ä¸åŒçš„æ©ç æ“ä½œã€‚

# æ–°çš„æ¨¡å‹æ¶æ„

ç¥ç»è¯­è¨€æ¨¡å‹çš„æ ¸å¿ƒæ¥å£æ˜¯ä¸€ä¸ªå°† token åºåˆ—æ˜ å°„åˆ°ä¸Šä¸‹æ–‡åµŒå…¥çš„ç¼–ç å™¨ï¼š

`$$[\text{the, mouse, ate, the, cheese}] \stackrel{\phi}{\Rightarrow} 
 \left[
 \left(\begin{array}{c}1 \\ 0.1\end{array}\right),
 \left(\begin{array}{l}0 \\ 1\end{array}\right),
 \left(\begin{array}{l}1 \\ 1\end{array}\right),
 \left(\begin{array}{c}1 \\ -0.1\end{array}\right),
 \left(\begin{array}{c}0 \\ -1\end{array}\right)
 \right]$$` 

ä»¥ GTP-3 ä¸ºä¾‹ï¼Œå®ƒæ˜¯ä¸€ä¸ªé€šè¿‡å †å  96 å±‚ Transformer blockï¼Œæ˜ å°„ token åºåˆ— `$x_{1:L}$` çš„ç¥ç»è¯­è¨€æ¨¡å‹ï¼š

`$$\text{GPT-3}(x_{1:L}) = \text{TransformerBlock}^{96}(\text{EmbedTokenWithPosition(x_{1:L})})$$`

å…¶ä¸­ï¼Œæ¯å±‚ TransformerBlock ä½¿ç”¨ï¼š

* Self-Attention(è‡ªæ³¨æ„åŠ›å±‚)ï¼Œå…è®¸æ¯ä¸ª token è¿›è¡Œäº¤äº’ï¼›
* FeedForward(å‰é¦ˆå…¨è¿æ¥å±‚)ï¼Œç‹¬ç«‹å¤„ç†æ¯ä¸ª tokenï¼š

`$$\text{TransformerBlock}(x_{1:L}) = \text{AddNorm}(\\
\text{FeedForward}, \\
\text{AddNorm}(\text{SelfAttention}, x_{1:L}))$$`

**å…ˆéªŒçŸ¥è¯†ï¼š** è¿™ç§ç¨ å¯†çš„ Transformer æ¨¡å‹æ¶æ„æ˜¯ç›®å‰å¼€å‘å¤§è¯­è¨€æ¨¡å‹çš„ä¸»è¦èŒƒå¼ï¼›
ä½†æ˜¯ï¼Œæ‰©å±•è¿™ç§æ¨¡å‹å¹¶éæ˜“äº‹ï¼Œéœ€è¦æ•°æ®ã€æ¨¡å‹å’Œæµæ°´å¹¶è¡Œã€‚

**ç°çŠ¶ï¼š** æ¨¡å‹çš„è§„æ¨¡å·²ç»åˆ°äº†æé™ï¼Œéšç€æ¨¡å‹è¶Šæ¥è¶Šå¤§ï¼Œå®ƒä»¬å¿…é¡»è¢«æ‹†åˆ†åˆ°æ›´å¤šçš„æœºå™¨ä¸Šï¼Œ
ç½‘ç»œå¸¦å®½æˆä¸ºäº†æ¨¡å‹è®­ç»ƒçš„ç“¶é¢ˆã€‚

> ä¸‹é¢æ˜¯ä¸€ä¸ªæ¨¡å‹å¹¶è¡Œç¤ºä¾‹ï¼š
> 
> * GPU1[layer1, layer2]
> * GPU2[layer3, layer4]
> * GPU3[layer5, layer6]

å› æ­¤ï¼Œå¦‚æœè¦ç»§ç»­æ‰©å¤§è§„æ¨¡ï¼Œéœ€è¦é‡æ–°æ€è€ƒå¦‚ä½•æ„å»ºå¤§è¯­è¨€æ¨¡å‹ã€‚ä¸€ç§æ€è·¯æ˜¯ï¼Œ
å¯¹äºç¨ å¯†çš„ Transformer æ¨¡å‹ï¼Œæ¯ä¸ªè¾“å…¥ä½¿ç”¨è¯­è¨€æ¨¡å‹çš„ç›¸åŒï¼ˆæ‰€æœ‰ï¼‰å‚æ•°ï¼ˆå¦‚ GPT-3 çš„ 175B å‚æ•°ï¼‰ã€‚
ç›¸åï¼Œå¯ä»¥è®©æ¯ä¸ªè¾“å…¥ä½¿ç”¨ä¸åŒï¼ˆæ›´å°çš„ï¼‰çš„å‚æ•°å­é›†ã€‚

ä¸‹é¢å°†è®¨è®ºä¸¤ç§ç±»å‹çš„æ–°æ¨¡å‹æ¶æ„ï¼Œå®ƒä»¬æé«˜äº†æ¨¡å‹çš„è§„æ¨¡ä¸Šé™ï¼š

* æ··åˆä¸“å®¶æ¨¡å‹ï¼šåˆ›å»ºä¸€ç»„ä¸“å®¶ï¼Œæ¯ä¸ªè¾“å…¥åªæ¿€æ´»ä¸€å°éƒ¨åˆ†ä¸“å®¶ã€‚
  ç±»ä¼¼ä¸€ä¸ªç”±ä¸“å®¶ç»„æˆçš„å’¨è¯¢å§”å‘˜ä¼šï¼Œæ¯ä¸ªäººéƒ½æœ‰ä¸åŒçš„èƒŒæ™¯ï¼ˆå¦‚å†å²ã€æ•°å­¦ã€ç§‘å­¦ç­‰ï¼‰ï¼›

    ```
    input => expert1 expert2 expert3 expert4 => output
    ```

* åŸºäºæ£€ç´¢çš„æ¨¡å‹ï¼šç»™å®šä¸€ä¸ªæ–°çš„è¾“å…¥ï¼Œæœ‰ä¸€ä¸ªåŸå§‹æ•°æ®å­˜å‚¨åº“ï¼Œæ£€ç´¢å­˜å‚¨åº“ä¸­å’Œå®ƒç›¸å…³çš„éƒ¨åˆ†ï¼Œ
  å¹¶ä½¿ç”¨å®ƒä»¬æ¥é¢„æµ‹è¾“å‡ºã€‚ç±»ä¼¼äºï¼Œå¦‚æœæœ‰äººé—®ä½ ä¸€ä¸ªé—®é¢˜ï¼Œä½ ä¼šè¿›è¡Œç½‘ç»œæœç´¢ï¼Œ
  å¹¶é˜…è¯»æœç´¢å¾—åˆ°çš„æ–‡æ¡£ä»¥å¾—å‡ºç­”æ¡ˆã€‚

    ```
    store|input => relevant data from store => output
    ```

## æ··åˆä¸“å®¶æ¨¡å‹

æ··åˆä¸“å®¶æ¨¡å‹å¯ä»¥è¿½æº¯åˆ° [Jacobs et al. (1991)](https://www.cs.toronto.edu/~fritz/absps/jjnh91.pdf)ï¼š

![img](images/moe.png)

ä¸ºäº†ä»‹ç»åŸºæœ¬æ€æƒ³ï¼Œå‡è®¾æˆ‘ä»¬æ­£åœ¨è§£å†³ä¸€ä¸ªé¢„æµ‹é—®é¢˜ï¼š

`$$x \in \mathbb{R}^{d} \Rightarrow y \in \mathbb{R}^{d}$$`

ä»å­¦ä¹ å‰é¦ˆï¼ˆReLUï¼‰ç¥ç»ç½‘ç»œå¼€å§‹ï¼š

`$$h_{\theta}(x) = W_{2}\text{max}(W_{1}x, 0)$$`

å…¶ä¸­ï¼Œ`$\theta = (W_{1}, W_{2})$` ä¸ºå‚æ•°ã€‚

## åŸºäºæ£€ç´¢çš„æ¨¡å‹
